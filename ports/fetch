#!/bin/bash

# ██╗  ██╗██████╗  ██████╗ ███████╗
# ██║ ██╔╝██╔══██╗██╔═══██╗██╔════╝
# █████╔╝ ██║  ██║██║   ██║███████╗
# ██╔═██╗ ██║  ██║██║   ██║╚════██║
# ██║  ██╗██████╔╝╚██████╔╝███████║
# ╚═╝  ╚═╝╚═════╝  ╚═════╝ ╚══════╝
# ---------------------------------
#   KD's Homebrew Linux Distro
# ---------------------------------

# Smart fetch - Download sources to ports directories
# Reads kpkgbuild files to determine what to download

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PORT_REPO="$SCRIPT_DIR/core"

echo "==> Fetching sources for all ports..."

fetch_port() {
    local portdir=$1
    local portname=$(basename "$portdir")
    
    cd "$portdir" || return 1
    
    # Check if kpkgbuild exists
    if [ ! -f "./kpkgbuild" ]; then
        echo "⚠  $portname: No kpkgbuild found"
        return 0
    fi
    
    # Source the kpkgbuild to get source URLs
    unset name version source vendoring
    . ./kpkgbuild 2>/dev/null || {
        echo "⚠  $portname: Failed to source kpkgbuild"
        return 0
    }
    
    [ -z "$source" ] && {
        echo "⚠  $portname: No source defined"
        return 0
    }
    
    # Download each source
    for src in $source; do
        case $src in
            *::*)
                # Format: filename::url
                filename="${src%%::*}"
                url="${src#*::}"
                ;;
            http://*|https://*|ftp://*)
                # Just a URL, extract filename
                filename=$(basename "$src")
                url="$src"
                ;;
            *)
                # Local file or plain filename, skip download
                echo "⊙  $portname: $src (local file, skipping)"
                continue
                ;;
        esac
        
        if [ -f "./$filename" ]; then
            echo "✓  $portname: $filename exists"
        else
            echo "⬇  $portname: Downloading $filename..."
            wget -q --show-progress -O "./$filename" "$url" || {
                echo "✗  $portname: Failed to download $filename"
                rm -f "./$filename"
                return 1
            }
            echo "✓  $portname: Downloaded $filename"
        fi
    done
    
    # Handle vendoring if requested
    if [ "$vendoring" = "rust" ]; then
        vendor_file="${name}-vendor-${version}.tar.xz"
        if [ -f "./$vendor_file" ]; then
             echo "✓  $portname: Vendor file $vendor_file exists"
        else
            echo "⚙  $portname: Generating vendor tarball..."
            
            # Create temp dir
            tmp_dir=$(mktemp -d)
            
            # Extract main source (assume first source is main)
            first_src=$(echo $source | cut -d' ' -f1)
            case $first_src in
                *::*) filename="${first_src%%::*}" ;;
                *) filename=$(basename "$first_src") ;;
            esac
            
            tar xf "$filename" -C "$tmp_dir" --strip-components=1
            
            # Vendor dependencies
            pushd "$tmp_dir" >/dev/null
            mkdir -p .cargo
            cargo vendor > .cargo/config.toml
            
            # Create vendor tarball
            tar -cJf "$portdir/$vendor_file" vendor .cargo
            popd >/dev/null
            
            # Cleanup
            rm -rf "$tmp_dir"
            echo "✓  $portname: Created $vendor_file"
        fi
    elif [ "$vendoring" = "go" ]; then
        vendor_file="${name}-vendor-${version}.tar.xz"
        if [ -f "./$vendor_file" ]; then
             echo "✓  $portname: Vendor file $vendor_file exists"
        else
            echo "⚙  $portname: Generating vendor tarball (Go)..."
            tmp_dir=$(mktemp -d)
            first_src=$(echo $source | cut -d' ' -f1)
            case $first_src in
                *::*) filename="${first_src%%::*}" ;;
                *) filename=$(basename "$first_src") ;;
            esac
            
            tar xf "$filename" -C "$tmp_dir" --strip-components=1
            
            pushd "$tmp_dir" >/dev/null
            go mod vendor
            tar -cJf "$portdir/$vendor_file" vendor
            popd >/dev/null
            
            rm -rf "$tmp_dir"
            echo "✓  $portname: Created $vendor_file"
        fi
    elif [ "$vendoring" = "node" ]; then
        vendor_file="${name}-vendor-${version}.tar.xz"
        if [ -f "./$vendor_file" ]; then
             echo "✓  $portname: Vendor file $vendor_file exists"
        else
            echo "⚙  $portname: Generating vendor tarball (Node)..."
            tmp_dir=$(mktemp -d)
            first_src=$(echo $source | cut -d' ' -f1)
            case $first_src in
                *::*) filename="${first_src%%::*}" ;;
                *) filename=$(basename "$first_src") ;;
            esac
            
            tar xf "$filename" -C "$tmp_dir" --strip-components=1
            
            pushd "$tmp_dir" >/dev/null
            npm install --ignore-scripts --no-audit --no-fund
            tar -cJf "$portdir/$vendor_file" node_modules
            popd >/dev/null
            
            rm -rf "$tmp_dir"
            echo "✓  $portname: Created $vendor_file"
        fi
    fi
    
    return 0
}

# Fetch all ports
total=0
success=0
failed=0

for portdir in "$PORT_REPO"/*; do
    [ -d "$portdir" ] || continue
    total=$((total + 1))
    
    if fetch_port "$portdir"; then
        success=$((success + 1))
    else
        failed=$((failed + 1))
    fi
done

echo ""
echo "==> Summary: $success/$total successful, $failed failed"
[ $failed -eq 0 ] || exit 1

